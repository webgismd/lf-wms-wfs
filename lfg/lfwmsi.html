<!DOCTYPE html>

<html>
<head>
  <meta charset="UTF-8">
  <meta name="generator" content=
  "HTML Tidy for Windows (vers 14 February 2006), see www.w3.org">
  <title>DataBC Public WMS</title>
  
  <script src="./js/leaflet.ajax.js" type="text/javascript"></script>
  <script src="./js/proj4js/lib/proj4js-compressed.js" type=  "text/javascript"></script>
  <script src="http://code.jquery.com/jquery-1.10.2.min.js" type=  "text/javascript"></script>
  
  <!-- Load Leaflet from CDN-->
  <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v1.0.0-beta.2/leaflet.css" />
  <script src="http://cdn.leafletjs.com/leaflet/v1.0.0-beta.2/leaflet.js"></script>

  <!-- Load Esri Leaflet locally, after cloning this repository -->
  <script src="http://cdn.jsdelivr.net/leaflet.esri/2.0.0-beta.7/esri-leaflet.js"></script>

	
</head>

<body>
  <div style="width:1000px; height:700px" id="map">
  </div><script type="text/javascript">

       //create map object
      var map = new L.Map('map', {
          center: [52, -123.3],
          zoom: 5
          //layers: [mqLayer]
      });

	  L.esri.tiledMapLayer({
  url: 'http://test.maps.gov.bc.ca/arcserver/rest/services/province/roads_wm/MapServer',
  maxZoom: 15
}).addTo(map);

	  
     var l = getURLParameters("l");
    
  var owsrootUrl = 'http://openmaps.gov.bc.ca/geo/ows';

  var fclayer = L.tileLayer.wms(owsrootUrl, {
    format: 'image/png',
    transparent: true,
    layers: l
  }).addTo(map);

  //Query layer functionality.
    var selectedFeature;
    var queryCoordinates;
    var src = new Proj4js.Proj('EPSG:4326');
    var dst = new Proj4js.Proj('EPSG:3005');
    
        map.on('click', function(e) {
        if (selectedFeature) {
            map.removeLayer(selectedFeature);
        }        
        
        var p = new Proj4js.Point(e.latlng.lng,e.latlng.lat);
        Proj4js.transform(src, dst, p);
        queryCoordinates = e.latlng;
        
        var defaultParameters = {
            service : 'WFS',
            version : '1.0.0',
            request : 'GetFeature',
            typeNames : l,
            maxFeatures : 100,
            outputFormat : 'text/javascript',
            format_options : 'callback:getJson',
            srsName : 'EPSG:4326'
        };

        var customParamsG = {cql_filter:'DWithin(GEOMETRY, POINT(' + p.x + ' ' + p.y + '), 15000, meters)'        };
        var customParamsS = {cql_filter:'DWithin(SHAPE, POINT(' + p.x + ' ' + p.y + '), 15000, meters)'        };
        
        var url = owsrootUrl + L.Util.getParamString(L.Util.extend(defaultParameters, customParamsG));
        var retryurl = owsrootUrl + L.Util.getParamString( L.Util.extend(defaultParameters, customParamsS));
       // console.log(url);
       // console.log(retryurl);
       
         retryfirst(url, retryurl);
                 });
    
  function retryfirst(url, retryurl) {
             $.ajax({
                url : url,
                dataType : 'jsonp',
                jsonpCallback : 'getJson',
                success : handleJson,
                error: function(jqXHR, textStatus, errorThrown) {  retrysecond(retryurl);}
                });
        }
                
  function retrysecond(urlretry) {
             $.ajax({
                url : urlretry,
                dataType : 'jsonp',
                jsonpCallback : 'getJson',
                success : handleJson
                });
                
        }
        
  function highlightFeature(e) {
        var layer = e.target;
        layer.setStyle({
            fillColor: "yellow",
            color: "yellow",
            weight: 5,
            opacity: 1
        });
        if (!L.Browser.ie && !L.Browser.opera) {
            layer.bringToFront();
        }
    }
  function resetHighlight(e) {
        var layer = e.target;
        layer.setStyle({
            radius: 5,
            fillColor: "yellow",
            color: "yellow",
            weight: 5,
            opacity: 0.6,
            fillOpacity: 0.2
        });
    }

        
  function handleJson(data) {
        selectedFeature = L.geoJson(data, {
            style: function (feature) {
                return {color: 'yellow'};
            },
            onEachFeature: function (feature, layer) {
                var content = "";
                content = content + "<b><u>" + feature.id.split('.')[0] + "<\/b><\/u><br>";
                delete feature.properties.bbox;
                for (var name in feature.properties) {
                                       content = content + "<b>" + name + ":<\/b> " + feature.properties[name] + "<br>";
                                           }
                var popup = L.popup().setLatLng(queryCoordinates).setContent(content).openOn(map);
                layer.bindPopup(content);
                layer.on({
                    mouseover: highlightFeature,
                    mouseout: resetHighlight
                });
            },                
            pointToLayer: function (feature, latlng) {
                return L.circleMarker(latlng, {
                    radius: 5,
                    fillColor: "yellow",
                    color: "#000",
                    weight: 5,
                    opacity: 0.6,
                    fillOpacity: 0.2
                });
            }
        });
        selectedFeature.addTo(map);
    }
        
                
  function popUp(f,l){
    var out = [];
    if (f.properties){
        for(key in f.properties){
            out.push(key+": "+f.properties[key]);
        }
        l.bindPopup(out.join("<br />"));
    }
  }

  function getURLParameters(paramName)
  {
    var sURL = window.document.URL.toString();
    if (sURL.indexOf("?") > 0)
    {
        var arrParams = sURL.split("?");
        var arrURLParams = arrParams[1].split("&");
        var arrParamNames = new Array(arrURLParams.length);
        var arrParamValues = new Array(arrURLParams.length);

        var i = 0;
        for (i = 0; i<arrURLParams.length; i++)
        {
            var sParam =  arrURLParams[i].split("=");
            arrParamNames[i] = sParam[0];
            if (sParam[1] !== ""){
                arrParamValues[i] = unescape(sParam[1]);
                                }
            else{
                arrParamValues[i] = "No Value";
                                }
        }

        for (i=0; i<arrURLParams.length; i++)
        {
            if (arrParamNames[i] == paramName)
            {
                //alert("Parameter:" + arrParamValues[i]);
                return arrParamValues[i];
            }
        }
        return "No Parameters Found";
    }
  }
  </script>
</body>
</html>
